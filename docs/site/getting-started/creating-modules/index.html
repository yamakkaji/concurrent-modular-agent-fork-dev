
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>3. Creating Modules (CoMA Interface) - CoMA</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="indigo" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#3-creating-modules-coma-interface" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="CoMA" class="md-header__button md-logo" aria-label="CoMA" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CoMA
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              3. Creating Modules (CoMA Interface)
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="CoMA" class="md-nav__button md-logo" aria-label="CoMA" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    CoMA
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../creating-a-new-project" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Creating a New Project
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Creating Modules
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../running-the-agent" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Running the Agent
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#make-a-modeule" class="md-nav__link">
    <span class="md-ellipsis">
      Make a modeule
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Make a modeule">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make-a-new-project-directory-with-agent-directory" class="md-nav__link">
    <span class="md-ellipsis">
      Make a new project directory with agent directory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-a-new-module-file" class="md-nav__link">
    <span class="md-ellipsis">
      Make a new module file
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make-a-new-module-definition" class="md-nav__link">
    <span class="md-ellipsis">
      Make a new module definition
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Make a new module definition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#disecting-the-module-code" class="md-nav__link">
    <span class="md-ellipsis">
      Disecting the module code
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make-a-chat-module" class="md-nav__link">
    <span class="md-ellipsis">
      Make a chat module
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Make a chat module">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#disecting-the-chat-module-code" class="md-nav__link">
    <span class="md-ellipsis">
      Disecting the chat module code
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make-a-memory-organizer-module" class="md-nav__link">
    <span class="md-ellipsis">
      Make a memory organizer module
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Make a memory organizer module">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#disecting-the-memory-organizer-module-code" class="md-nav__link">
    <span class="md-ellipsis">
      Disecting the memory organizer module code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#concurrency-of-memory-organizer-module" class="md-nav__link">
    <span class="md-ellipsis">
      Concurrency of memory organizer module
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="3-creating-modules-coma-interface">3. Creating Modules (CoMA Interface)</h1>
<h2 id="make-a-modeule">Make a modeule</h2>
<p>In this section, we will create three simple modules that well explain the basic concepts of CoMA modules.
These modules will be used to build a simple chat application that can respond to user input.
We will create the following modules:</p>
<ol>
<li>
<p><code>user_input</code>: A module that receives user input and sends it to the <code>chat</code> module.</p>
</li>
<li>
<p><code>chat</code>: A module that receives messages from the <code>user_input</code> module and responds to the user.</p>
</li>
<li>
<p><code>memory_organizer</code>: A module that organizes the memory of the agent.</p>
</li>
</ol>
<p><img alt="Overview of a simple CoMA agent" src="../../img/my-first-coma.png" /></p>
<h3 id="make-a-new-project-directory-with-agent-directory">Make a new project directory with agent directory</h3>
<p>To start your first project, create a directory named <code>my_project</code> and <code>my_project/agent1</code> or do </p>
<pre><code class="language-shell">mkdir -p my_project/agent1
</code></pre>
<h3 id="make-a-new-module-file">Make a new module file</h3>
<p>Next, create a file named <code>user_input.py</code> in the <code>my_project/agent1</code> directory. This file will define your first module, which is a simple chat module that can respond to user input.</p>
<pre><code class="language-shell">touch my_project/agent1/user_input.py
</code></pre>
<h2 id="make-a-new-module-definition">Make a new module definition</h2>
<p>Now, open <code>user_input.py</code> in your favorite text editor and add the following code:</p>
<pre><code class="language-python"># my_project/agent1/user_input.py
import time
import concurrent_modular_agent as coma

@coma.module_main('user_input')
def mod_user_input(agent:coma.AgentInterface):
    while True:                              # continuously run this module
        m = input(&quot;User: &quot;)
        if len(m) == 0 or m.isspace() or m is None:  # if the user input is empty, skip to the next iteration
            continue
        agent.state.add(f&quot;user_message:{m}&quot;)
        agent.message.send(&quot;chat&quot;, &quot;reply to user&quot;)  # send message to the &quot;chat&quot; module
        time.sleep(3)                        # wait for 3 seconds before next input
</code></pre>
<p>Overall, this code defines a module named <code>user_input</code> that continuously receives user inputs. When the user enters a message (<code>m</code> in the code above), it adds the message to the agent's <em>state</em> and sends a message to the "<code>chat</code>" module to reply. </p>
<p>Let's disect this code to get a sense of how CoMA modules work.</p>
<h3 id="disecting-the-module-code">Disecting the module code</h3>
<p>The first line imports the <code>concurrent_modular_agent</code> package, which provides the necessary functions and classes to define and run CoMA modules.</p>
<p>The <code>@coma.module_main(module_name)</code> decorator instantiate an <code>AgentInterface</code> object with the specified name of the module. This object provides basic functionalities for modules, state IO and messaging IO. Using this decorator turns a function which takes an <code>AgentInterface</code> object as an argument into a module function. Notice that the <code>module_name</code> is specified as <code>'user_input'</code>, which can be different from the file name or the function name. </p>
<pre><code class="language-python">
### Module function
The `mod_user_input` function is the main function of the module. Let's break down its components:
```python
while True:
    ...
    time.sleep(3)
</code></pre>
<p>This loop ensures that the module runs continuously, allowing it to receive user inputs repeatedly. The <code>time.sleep(3)</code> line introduces a 3-second delay between each input, preventing the module from overwhelming the user with prompts.</p>
<pre><code class="language-python">m = input(&quot;User: &quot;)
if len(m) == 0 or m.isspace() or m is None:
    continue
</code></pre>
<p>This line receives input from the user. The input is stored in the variable <code>m</code>. 
If the user input is empty (i.e., the user just pressed Enter without typing anything), only whitespace, or <code>None</code>, the module skips to the next iteration of the loop, effectively ignoring empty inputs.</p>
<pre><code class="language-python">agent.state.add(f'user_message:{m}')
</code></pre>
<p>This line adds the user message to the agent's state. 
The <strong>state</strong> is a shared memory space where modules can store and retrieve information. 
The <code>AgentInterface.state</code> object provides access to this state. 
The <code>AgentInterface.state.add</code> method is used to store new information in the state.
At this time, the received user input <code>user_message:{m}</code>, where <code>{m}</code> is the actual user input, is added to the state. </p>
<pre><code class="language-python">agent.message.send(&quot;chat&quot;, &quot;reply&quot;)
</code></pre>
<p>This line sends a message "<code>reply</code>" to the "<code>chat</code>" module. 
The <code>message</code> object allows modules to communicate with each other by sending and receiving messages. 
At this time, the <code>send</code> method is used to send a message to the "<code>chat</code>" module, which is expected to handle the reply.</p>
<h2 id="make-a-chat-module">Make a chat module</h2>
<p>Next, create a file named <code>chat.py</code> in the <code>my_project/agent1</code> directory. This file will define your second module, which is a simple chat module that can respond to user input.</p>
<pre><code class="language-shell">touch my_project/agent1/chat.py
</code></pre>
<p>Now, open <code>chat.py</code> in your favorite text editor and add the following code:</p>
<pre><code class="language-python"># my_project/agent1/chat.py
@coma.module_main('chat')
def mod_response_to_user(agent:coma.AgentInterface):
    openai_client = OpenAI()
    while True:
        m = agent.message.receive()
        if m is None:
            continue  # If no message is received, skip to the next iteration
        messages = [
            {&quot;role&quot;: &quot;developer&quot;, &quot;content&quot;: &quot;You are a module of an autonomous agent. Your job is to respond to the user's input. You are expected to talk with the user. You are not an AI assistant, so feel free to talk freely. You do not need to help humans. You received the following messages from the user, other modules. Talk to the user in a natural way.&quot;},
        ]
        for s in agent.state.get(max_count=10).texts[::-1]:
            if s.startswith(&quot;user_message:&quot;):
                messages.append({&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: s[len(&quot;user_message:&quot;):]})
            elif s.startswith(&quot;assistant_message:&quot;):
                messages.append({&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: s[len(&quot;assistant_message:&quot;):]})
        messages.append({&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: f&quot;{m}})

        completion = openai_client.chat.completions.create(
            model=&quot;gpt-4o&quot;,
            messages=messages,
        )
        output_message = completion.choices[0].message.content
        print(f'ChatBot: {output_message}')
        agent.state.add(f&quot;assistant_message:{output_message}&quot;)

        agent.message.send(&quot;user_input&quot;, 'chat response finished')
</code></pre>
<h3 id="disecting-the-chat-module-code">Disecting the chat module code</h3>
<p>The basics are similar to the <code>user_input</code> module. 
The module is defined with the <code>@coma.module_main('chat')</code> decorator, which allows it to be recognized as a module named "<code>chat</code>". 
The <code>mod_response_to_user</code> function is the main function of the module. 
It continuously listens for messages from the <code>user_input</code> module and sends responses back to the module like the last module.</p>
<pre><code class="language-python">@coma.module_main('chat')
def mod_response_to_user(agent:coma.AgentInterface):
    ...
    while True:
        m = agent.message.receive()               # receive message from user_input module
        ...
        agent.message.send(&quot;user_input&quot;, 'chat response finished') # send message to user_input module to tell it finished processing
</code></pre>
<p>There are four new things in this module code.
The first is when the module activates. </p>
<pre><code class="language-python">while True:
    m = agent.message.receive()
    if m is None:
        continue  # If no message is received, skip to the next iteration
</code></pre>
<p>The module runs continuously, waiting for messages from the <code>user_input</code> module.
If the module receives a message, it activates and processes the message to respond to the user.</p>
<p>The second is LLM interface. At this moment, we use <em>OpenAI</em>'s API to interact with the LLM.</p>
<pre><code class="language-python">openai_client = OpenAI()
...
        completion = openai_client.chat.completions.create(
            model=&quot;gpt-4o&quot;,
            messages=messages,
        )
</code></pre>
<p>The third is state retrieval. </p>
<pre><code class="language-python">for s in agent.state.get(max_count=10).texts[::-1]:
    if s.startswith(&quot;user_message:&quot;):
        messages.append({&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: s[len(&quot;user_message:&quot;):]})
    elif s.startswith(&quot;assistant_message:&quot;):
        messages.append({&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: s[len(&quot;assistant_message:&quot;):]})
</code></pre>
<p>We retrieve the latest state using <code>AgentInterface.state.get()</code>, which returns the most recent state of the agent. The <code>texts</code> property of the state object contains all text entries in the state, and we reverse it to process the most recent messages first.</p>
<p>The obtained state is checked for messages that start with <code>user_message:</code> or <code>assistant_message:</code>. 
If the message starts with <code>user_message:</code>, it is treated as a user message, and if it starts with <code>assistant_message:</code>, it is treated as an assistant message. 
The messages are then appended to the <code>messages</code> list, which will be sent to the LLM.</p>
<p>The fourth is output to the user.</p>
<pre><code class="language-python">output_message = completion.choices[0].message.content
print(f'ChatBot: {output_message}')
agent.state.add(f'assistant_message:{output_message}')
</code></pre>
<p>The output from the LLM is stored in the <code>output_message</code> variable, which is then printed to the console. 
The output message is also added to the agent's state with the prefix <code>assistant_message:</code>.</p>
<p>In the end, the module sends a message to the <code>user_input</code> module to signal that it has finished processing the input and is ready for the next message.</p>
<pre><code class="language-python">agent.message.send(&quot;user_input&quot;, 'finish')
</code></pre>
<h2 id="make-a-memory-organizer-module">Make a memory organizer module</h2>
<p>Next, create a file named <code>memory_organizer.py</code> in the <code>my_project/agent1</code> directory. This file will define your third module, which is a simple memory organizer module that organizes the memory of the agent.</p>
<pre><code class="language-shell">touch my_project/agent1/memory_organizer.py
</code></pre>
<p>Now, open <code>memory_organizer.py</code> in your favorite text editor and add the following code:</p>
<pre><code class="language-python"># my_project/agent1/memory_organizer.py
import time
import random

import concurrent_modular_agent as coma
from concurrent_modular_agent import OpenAI

@coma.module_main('memory_organizer')
def mod_organize_memory(agent: coma.AgentInterface):
    openai_client = OpenAI()
    while True:
        m = agent.message.receive()
        messages = [
            {&quot;role&quot;: &quot;developer&quot;, &quot;content&quot;: &quot;You are a module of an autonomous agent. Your job is to organize the memory of the agent. You are expected to organize the memory of the agent in a way that is helpfull to recall the past and what the agent had thought. You will be given a list of memory of received the following messages from the user, other modules.&quot;},
        ]
        organizing_range = random.randint(5, 10)  # Randomly decide how many messages to organize
        for s in agent.state.get(max_count=10).texts[::-organizing_range]:
            if s.startswith(&quot;user_message:&quot;):
                messages.append({&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: s[len(&quot;user_message:&quot;):]})
            elif s.startswith(&quot;assistant_message:&quot;):
                messages.append({&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: s[len(&quot;assistant_message:&quot;):]})
        messages.append({&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: f&quot;{m}})

        completion = openai_client.chat.completions.create(
            model=&quot;gpt-4.1-nano-2025-04-14&quot;,
            messages=messages,
        )
        output_message = completion.choices[0].message.content
        agent.state.add(f'assistant_message:{output_message}')

        time.sleep(100)  # Wait for 3 seconds before next input
</code></pre>
<h3 id="disecting-the-memory-organizer-module-code">Disecting the memory organizer module code</h3>
<p>The <code>memory_organizer</code> module is similar to the <code>chat</code> module, but it has a different purpose.
It organizes the memory of the agent stored in the state.</p>
<p>The main part of the module is collect a random numbers of states from the shared memory and send them to the LLM to organize the memory.</p>
<p>This part collects 5~10 states from the agent's memory:</p>
<pre><code class="language-python">organizing_range = random.randint(5, 10)  # Randomly decide how many messages to organize
for s in agent.state.get(max_count=10).texts[::-organizing_range]:
    if s.startswith(&quot;user_message:&quot;):
        messages.append({&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: s[len(&quot;user_message:&quot;):]})
    elif s.startswith(&quot;assistant_message:&quot;):
        messages.append({&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: s[len(&quot;assistant_message:&quot;):]})
messages.append({&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: f&quot;{m}})
</code></pre>
<p>The output of the LLM is stored to memory as an <code>assistant_message</code>:</p>
<pre><code class="language-python">output_message = completion.choices[0].message.content
agent.state.add(f'assistant_message:{output_message}')
</code></pre>
<p>Notice that the <code>memory_organizer</code> module does not send any message to other modules.</p>
<h3 id="concurrency-of-memory-organizer-module">Concurrency of memory organizer module</h3>
<p>The <code>memory_organizer</code> module is designed to run concurrently with the <code>user_input</code> and <code>chat</code> modules.
This means that it can run in parallel with the other modules, allowing it to organize the memory of the agent while the user is interacting with the agent.
Although both <code>user_input</code> and <code>chat</code> modules are designed to run continuously, <code>user_input</code> module will send messages only when the user inputs a message, and <code>chat</code> module will send messages only when it receives a message from the <code>user_input</code> module.
The <code>memory_organizer</code> module will run continuously without activating. </p>
<div style="text-align: center; margin: 2rem 0;">
    <a href="../running-the-agent" class="indigo-button">
        ðŸš€ Running the Agent
    </a>
</div>

<style>
.indigo-button {
    display: inline-block;
    padding: 12px 32px;
    background-color: #3F51B5;
    color: #FFFFFF !important;
    text-decoration: none !important;
    border-radius: 6px;
    font-weight: 600;
    font-size: 16px;
    box-shadow: 0 3px 6px rgba(63, 81, 181, 0.25);
    transition: all 0.2s ease;
    border: none;
}

.indigo-button:hover {
    background-color: #303F9F;
    box-shadow: 0 4px 8px rgba(63, 81, 181, 0.35);
    transform: translateY(-1px);
    color: #FFFFFF !important;
    text-decoration: none !important;
}

.indigo-button:visited {
    color: #FFFFFF !important;
}

.indigo-button:active {
    color: #FFFFFF !important;
}
</style>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>